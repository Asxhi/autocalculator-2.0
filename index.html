<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–≤—Ç–æ-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–∫—É–ø–∫–µ –º—è–∫–æ—Ç–∏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 15px auto;
      padding: 15px;
      background-color: #f9f9f9;
    }

    .upload-section {
      margin-bottom: 20px;
      text-align: center;
    }
    .upload-btn {
      display: inline-block;
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .preview-img {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .controls {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-analyze { background-color: #1976d2; color: white; }
    .btn-clear { background-color: #ff9800; color: white; }

    .results {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .result-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .item-name {
      font-weight: bold;
      display: inline-block;
      margin-right: 10px;
    }
    .item-qty {
      color: #2e7d32;
      margin-right: 10px;
    }
    .item-total {
      font-weight: bold;
      color: #c62828;
    }

    .price-editor {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .price-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .price-label {
      flex: 1;
    }
    .price-input {
      width: 80px;
    }

    .report-section {
      margin-top: 25px;
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .clear-all-btn {
      background-color: #f44336;
      color: white;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <h1>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–∫—É–ø–∫–µ –º—è–∫–æ—Ç–∏</h1>

  <div class="upload-section">
    <label for="screenshotUpload" class="upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç</label>
    <input type="file" id="screenshotUpload" accept="image/*" style="display:none;" onchange="loadScreenshot()">
    <img id="screenshotPreview" class="preview-img" src="" alt="–ü—Ä–µ–≤—å—é" style="display:none;">
  </div>

  <div class="controls">
    <button class="btn btn-analyze" onclick="analyzeScreenshot()">üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë</button>
  </div>

  <div class="results" id="resultsContainer">
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë¬ª.</p>
  </div>

  <div class="price-editor">
    <h3>‚úèÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–Ω—ã (–æ–¥–∏–Ω —Ä–∞–∑)</h3>
    <div id="priceEditor"></div>
    <button class="btn btn-clear" onclick="savePrices()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã</button>
  </div>

  <div class="report-section">
    <h2>üìä –ò—Å—Ç–æ—Ä–∏—è</h2>
    <div id="reportContainer"></div>
  </div>

  <button class="clear-all-btn" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>

  <script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>

  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏: 5 –∫–æ–ª–æ–Ω–æ–∫, 4 —Ä—è–¥–∞
    const COLS = 5;
    const ROWS = 4;

    // –ë–∞–∑–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    let prices = {
      red: 150,
      blue: 120,
      yellow: 80,
      white: 100
    };

    let history = JSON.parse(localStorage.getItem('meatHistory')) || [];

    let currentImage = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function loadScreenshot() {
      const file = document.getElementById('screenshotUpload').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById('screenshotPreview').src = e.target.result;
        document.getElementById('screenshotPreview').style.display = 'block';
        currentImage = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
    function getColorType(r, g, b) {
      if (r > 180 && g < 120 && b < 120) return 'red';
      if (b > 180 && r < 120 && g < 120) return 'blue';
      if (r > 180 && g > 180 && b < 120) return 'yellow';
      if (r > 200 && g > 200 && b > 200) return 'white';
      return null;
    }

    // –ê–Ω–∞–ª–∏–∑ –≤—Å–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
    async function analyzeScreenshot() {
      if (!currentImage) {
        alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç!");
        return;
      }

      const resultsDiv = document.getElementById('resultsContainer');
      resultsDiv.innerHTML = '<p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º... –≠—Ç–æ –∑–∞–π–º—ë—Ç 10‚Äì30 —Å–µ–∫—É–Ω–¥.</p>';

      const img = new Image();
      img.src = currentImage;
      await new Promise(resolve => img.onload = resolve);

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      const cellW = img.width / COLS;
      const cellH = img.height / ROWS;

      let allItems = [];

      for (let row = 0; row < ROWS; row++) {
        for (let col = 0; col < COLS; col++) {
          // –¶–µ–Ω—Ç—Ä —è—á–µ–π–∫–∏ ‚Äî –¥–ª—è —Ü–≤–µ—Ç–∞
          const cx = col * cellW + cellW / 2;
          const cy = row * cellH + cellH / 2;
          const pixel = ctx.getImageData(cx, cy, 1, 1).data;
          const colorType = getColorType(pixel[0], pixel[1], pixel[2]);
          if (!colorType) continue;

          // –ü—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª ‚Äî –¥–ª—è OCR
          const tx = col * cellW + cellW - 30;
          const ty = row * cellH + 5;
          const tw = 30;
          const th = 20;

          const textCanvas = document.createElement('canvas');
          textCanvas.width = tw;
          textCanvas.height = th;
          const textCtx = textCanvas.getContext('2d');
          textCtx.drawImage(canvas, tx, ty, tw, th, 0, 0, tw, th);

          // –ß/–± + –∫–æ–Ω—Ç—Ä–∞—Å—Ç
          const imgData = textCtx.getImageData(0, 0, tw, th);
          for (let i = 0; i < imgData.data.length; i += 4) {
            const avg = (imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3;
            imgData.data[i] = avg > 128 ? 255 : 0;
            imgData.data[i+1] = avg > 128 ? 255 : 0;
            imgData.data[i+2] = avg > 128 ? 255 : 0;
          }
          textCtx.putImageData(imgData, 0, 0);

          // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ
          const scale = 2;
          const bigCanvas = document.createElement('canvas');
          bigCanvas.width = tw * scale;
          bigCanvas.height = th * scale;
          const bigCtx = bigCanvas.getContext('2d');
          bigCtx.imageSmoothingEnabled = false;
          bigCtx.drawImage(textCanvas, 0, 0, tw, th, 0, 0, bigCanvas.width, bigCanvas.height);

          try {
            const result = await Tesseract.recognize(
              bigCanvas.toDataURL(),
              'eng',
              { logger: m => {}, tessedit_char_whitelist: '0123456789xX' }
            );
            const text = result.data.text.trim().replace(/[^0-9xX]/g, '');
            const match = text.match(/(\d+)x/i);
            const qty = match ? parseInt(match[1]) : 1;

            if (qty >= 1 && qty <= 50) {
              const itemName = {
                red: "–ú—è–∫–æ—Ç—å –∫—É–±–æ—Ä–±—É–∑–∞",
                blue: "–ú—è–∫–æ—Ç—å —Å–ª–∞—Å—Ç–µ–Ω—ã",
                yellow: "–ú—è–∫–æ—Ç—å –ª–∏–º–æ–Ω–Ω–∏–∫–∞",
                white: "–ú—è–∫–æ—Ç—å —Å–æ–ª–µ–≤–∏–∫–∞"
              }[colorType];
              const total = prices[colorType] * qty;
              allItems.push({ name: itemName, qty, total, color: colorType });
            }
          } catch (e) {
            console.warn("OCR error in cell", row, col);
          }
        }
      }

      if (allItems.length === 0) {
        resultsDiv.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –º—è–∫–æ—Ç—å.</p>';
      } else {
        let html = '<h3>–ù–∞–π–¥–µ–Ω–æ:</h3>';
        allItems.forEach(item => {
          html += `<div class="result-item">
            <span class="item-name">${item.name}</span>
            <span class="item-qty">√ó${item.qty}</span>
            <span class="item-total">${item.total} r</span>
          </div>`;
        });
        html += `<button class="btn btn-analyze" onclick="saveAllItems(${JSON.stringify(allItems)})">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤—Å—ë –≤ –æ—Ç—á—ë—Ç</button>`;
        resultsDiv.innerHTML = html;
      }
    }

    function saveAllItems(items) {
      const today = new Date().toISOString().split('T')[0];
      items.forEach(item => {
        history.push({
          name: item.name,
          price: prices[item.color],
          quantity: item.qty,
          total: item.total,
          date: today
        });
      });
      localStorage.setItem('meatHistory', JSON.stringify(history));
      renderReport();
      document.getElementById('resultsContainer').innerHTML = '<p>–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—Ç—á—ë—Ç!</p>';
    }

    // –†–µ–¥–∞–∫—Ç–æ—Ä —Ü–µ–Ω
    function renderPriceEditor() {
      const div = document.getElementById('priceEditor');
      div.innerHTML = `
        <div class="price-row">
          <span class="price-label">–ú—è–∫–æ—Ç—å –∫—É–±–æ—Ä–±—É–∑–∞ (–∫—Ä–∞—Å–Ω–∞—è):</span>
          <input type="number" class="price-input" id="price-red" value="${prices.red}">
        </div>
        <div class="price-row">
          <span class="price-label">–ú—è–∫–æ—Ç—å —Å–ª–∞—Å—Ç–µ–Ω—ã (—Å–∏–Ω—è—è):</span>
          <input type="number" class="price-input" id="price-blue" value="${prices.blue}">
        </div>
        <div class="price-row">
          <span class="price-label">–ú—è–∫–æ—Ç—å –ª–∏–º–æ–Ω–Ω–∏–∫–∞ (–∂—ë–ª—Ç–∞—è):</span>
          <input type="number" class="price-input" id="price-yellow" value="${prices.yellow}">
        </div>
        <div class="price-row">
          <span class="price-label">–ú—è–∫–æ—Ç—å —Å–æ–ª–µ–≤–∏–∫–∞ (–±–µ–ª–∞—è):</span>
          <input type="number" class="price-input" id="price-white" value="${prices.white}">
        </div>
      `;
    }

    function savePrices() {
      prices = {
        red: parseFloat(document.getElementById('price-red').value) || 150,
        blue: parseFloat(document.getElementById('price-blue').value) || 120,
        yellow: parseFloat(document.getElementById('price-yellow').value) || 80,
        white: parseFloat(document.getElementById('price-white').value) || 100
      };
      localStorage.setItem('meatPrices', JSON.stringify(prices));
      alert("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    }

    function renderReport() {
      const div = document.getElementById('reportContainer');
      let totalSum = 0;
      let html = '';
      history.forEach(item => {
        totalSum += item.total;
        html += `<div class="result-item">‚Äì ${item.name} √ó${item.quantity} = ${item.total} r (${item.date})</div>`;
      });
      div.innerHTML = `
        <div>${html || '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>'}</div>
        <div class="summary" style="font-weight:bold; margin-top:10px;">–ò—Ç–æ–≥–æ: ${totalSum} r</div>
      `;
    }

    function clearAll() {
      if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?")) {
        history = [];
        localStorage.removeItem('meatHistory');
        renderReport();
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const savedPrices = JSON.parse(localStorage.getItem('meatPrices'));
    if (savedPrices) prices = savedPrices;
    renderPriceEditor();
    renderReport();
  </script>
</body>
</html>
