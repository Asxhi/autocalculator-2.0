<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–∫—É–ø–∫–µ –º—è–∫–æ—Ç–∏ (v3)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 15px auto;
      padding: 15px;
      background-color: #f9f9f9;
    }

    .upload-section {
      margin-bottom: 20px;
      text-align: center;
    }
    .upload-btn {
      display: inline-block;
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .preview-img {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: crosshair;
    }

    .controls {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-analyze { background-color: #1976d2; color: white; }
    .btn-clear { background-color: #ff9800; color: white; }

    .results {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .result-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .item-name {
      font-weight: bold;
      display: inline-block;
      margin-right: 10px;
    }
    .item-qty {
      color: #2e7d32;
      margin-right: 10px;
    }
    .item-total {
      font-weight: bold;
      color: #c62828;
    }

    .report-section {
      margin-top: 25px;
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .period-header {
      font-size: 1.1em;
      margin: 12px 0 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    .summary {
      margin-top: 8px;
      font-weight: bold;
    }
    .item {
      font-size: 0.92em;
      padding: 4px 0;
      color: #555;
    }
    .buy-item { color: #2e7d32; }

    .clear-all-btn {
      background-color: #f44336;
      color: white;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }

    .price-editor {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .price-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .price-label {
      flex: 1;
    }
    .price-input {
      width: 80px;
    }

    .highlight {
      position: absolute;
      border: 2px solid yellow;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <h1>ü§ñ –£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–∫—É–ø–∫–µ –º—è–∫–æ—Ç–∏ (v3) ‚Äî –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä —è—á–µ–µ–∫</h1>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ -->
  <div class="upload-section">
    <label for="screenshotUpload" class="upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç</label>
    <input type="file" id="screenshotUpload" accept="image/*" style="display:none;" onchange="loadScreenshot()">
    <img id="screenshotPreview" class="preview-img" src="" alt="–ü—Ä–µ–≤—å—é —Å–∫—Ä–∏–Ω—à–æ—Ç–∞" style="display:none;">
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div class="controls">
    <button class="btn btn-analyze" onclick="startManualSelection()">üéØ –í—ã–±—Ä–∞—Ç—å —è—á–µ–π–∫—É</button>
    <button class="btn btn-clear" onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
  <div class="results" id="analysisResults">
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å —è—á–µ–π–∫—É¬ª. –ó–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —è—á–µ–π–∫–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.</p>
  </div>

  <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Ü–µ–Ω -->
  <div class="price-editor">
    <h3>‚úèÔ∏è –ù–∞—Å—Ç—Ä–æ–π —Ü–µ–Ω—ã</h3>
    <div id="priceEditorContainer"></div>
    <button class="btn btn-edit" onclick="savePrices()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã</button>
  </div>

  <!-- –û—Ç—á—ë—Ç -->
  <div class="report-section">
    <h2>üìä –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h2>
    <div id="reportsContainer"></div>
  </div>

  <button class="clear-all-btn" onclick="clearAllData()">–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ</button>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tesseract.js -->
  <script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>

  <script>
    // –ë–∞–∑–∞ –º—è–∫–æ—Ç–∏ ‚Äî —Ü–µ–Ω—ã –∑–∞–¥–∞—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é
    let meatItems = [
      { id: 1, name: "–ú—è–∫–æ—Ç—å –∫—É–±–æ—Ä–±—É–∑–∞", price: 150, color: [255, 0, 0], icon: "https://via.placeholder.com/50/ff0000/ffffff?text=M" },
      { id: 2, name: "–ú—è–∫–æ—Ç—å —Å–ª–∞—Å—Ç–µ–Ω—ã", price: 120, color: [0, 0, 255], icon: "https://via.placeholder.com/50/0000ff/ffffff?text=S" },
      { id: 3, name: "–ú—è–∫–æ—Ç—å –ª–∏–º–æ–Ω–Ω–∏–∫–∞", price: 80, color: [255, 255, 0], icon: "https://via.placeholder.com/50/ffff00/000000?text=L" },
      { id: 4, name: "–ú—è–∫–æ—Ç—å —Å–æ–ª–µ–≤–∏–∫–∞", price: 100, color: [240, 240, 240], icon: "https://via.placeholder.com/50/f0f0f0/000000?text=V" }
    ];

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    let purchases = JSON.parse(localStorage.getItem('meatPurchases')) || [];

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
    let currentImage = null;
    let isSelecting = false;
    let highlightDiv = null;

    function loadScreenshot() {
      const input = document.getElementById('screenshotUpload');
      const preview = document.getElementById('screenshotPreview');

      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
          currentImage = e.target.result;
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
          preview.onclick = handleImageClick;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // –ù–∞—á–∞–ª–æ —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
    function startManualSelection() {
      if (!currentImage) {
        alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç!");
        return;
      }
      isSelecting = true;
      document.getElementById('analysisResults').innerHTML = '<p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —è—á–µ–π–∫–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.</p>';
      createHighlight();
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    function createHighlight() {
      if (highlightDiv) highlightDiv.remove();
      highlightDiv = document.createElement('div');
      highlightDiv.className = 'highlight';
      document.body.appendChild(highlightDiv);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    function handleImageClick(event) {
      if (!isSelecting) return;

      const img = event.target;
      const rect = img.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // –†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
      const cellWidth = img.width / 5;
      const cellHeight = img.height / 4;

      // –¶–µ–Ω—Ç—Ä —è—á–µ–π–∫–∏
      const centerX = Math.floor(x / cellWidth) * cellWidth + cellWidth / 2;
      const centerY = Math.floor(y / cellHeight) * cellHeight + cellHeight / 2;

      // –ü—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª –¥–ª—è OCR
      const textX = Math.floor(x / cellWidth) * cellWidth + cellWidth - 30;
      const textY = Math.floor(y / cellHeight) * cellHeight + 5;

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
      highlightDiv.style.left = `${rect.left + Math.floor(x / cellWidth) * cellWidth}px`;
      highlightDiv.style.top = `${rect.top + Math.floor(y / cellHeight) * cellHeight}px`;
      highlightDiv.style.width = `${cellWidth}px`;
      highlightDiv.style.height = `${cellHeight}px`;

      // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      const pixelData = ctx.getImageData(centerX, centerY, 1, 1).data;
      const [r, g, b] = pixelData;

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
      let closestItem = null;
      let minDistance = Infinity;

      meatItems.forEach(item => {
        const [cr, cg, cb] = item.color;
        const distance = Math.sqrt((r - cr) ** 2 + (g - cg) ** 2 + (b - cb) ** 2);
        if (distance < minDistance) {
          minDistance = distance;
          closestItem = item;
        }
      });

      // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ ‚Äî –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º
      if (minDistance > 150) {
        document.getElementById('analysisResults').innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —è—á–µ–π–∫—É.</p>';
        return;
      }

      // –†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Ç–µ–∫—Å—Ç –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
      const textWidth = 30;
      const textHeight = 20;

      const textCanvas = document.createElement('canvas');
      textCanvas.width = textWidth;
      textCanvas.height = textHeight;
      const textCtx = textCanvas.getContext('2d');
      textCtx.drawImage(canvas, textX, textY, textWidth, textHeight, 0, 0, textWidth, textHeight);

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á—ë—Ä–Ω–æ-–±–µ–ª–æ–µ —Å –≤—ã—Å–æ–∫–∏–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º
      const imageData = textCtx.getImageData(0, 0, textWidth, textHeight);
      for (let i = 0; i < imageData.data.length; i += 4) {
        const avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
        imageData.data[i] = avg > 128 ? 255 : 0;
        imageData.data[i+1] = avg > 128 ? 255 : 0;
        imageData.data[i+2] = avg > 128 ? 255 : 0;
        imageData.data[i+3] = 255;
      }
      textCtx.putImageData(imageData, 0, 0);

      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ OCR
      const scale = 2;
      const scaledCanvas = document.createElement('canvas');
      scaledCanvas.width = textWidth * scale;
      scaledCanvas.height = textHeight * scale;
      const scaledCtx = scaledCanvas.getContext('2d');
      scaledCtx.imageSmoothingEnabled = false;
      scaledCtx.drawImage(textCanvas, 0, 0, textWidth, textHeight, 0, 0, scaledCanvas.width, scaledCanvas.height);

      // –†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Ç–µ–∫—Å—Ç
      Tesseract.recognize(
        scaledCanvas.toDataURL(),
        'eng',
        { logger: m => {}, tessedit_char_whitelist: '0123456789xX' }
      ).then(result => {
        const text = result.data.text.trim().replace(/[^0-9xX]/gi, '');
        const qtyMatch = text.match(/(\d+)x/i);
        const quantity = qtyMatch ? parseInt(qtyMatch[1]) : 1;

        if (quantity >= 1 && quantity <= 50) {
          const total = closestItem.price * quantity;
          const item = {
            name: closestItem.name,
            price: closestItem.price,
            quantity,
            total,
            x: Math.round(textX),
            y: Math.round(textY)
          };

          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          const resultsDiv = document.getElementById('analysisResults');
          let html = `
            <h3>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:</h3>
            <div class="result-item">
              <span class="item-name">${item.name}</span>
              <span class="item-qty">√ó${item.quantity}</span>
              <span class="item-total">${item.total} r</span>
            </div>
            <button class="btn btn-save" onclick="saveSingleItem(${JSON.stringify(item)})">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –æ—Ç—á—ë—Ç</button>
            <button class="btn btn-analyze" onclick="startManualSelection()">üéØ –í—ã–±—Ä–∞—Ç—å –µ—â—ë —è—á–µ–π–∫—É</button>
          `;
          resultsDiv.innerHTML = html;
        } else {
          document.getElementById('analysisResults').innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —è—á–µ–π–∫—É.</p>';
        }
      }).catch(error => {
        document.getElementById('analysisResults').innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞ OCR: ${error.message}</p>`;
      });

      isSelecting = false;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
    function saveSingleItem(item) {
      purchases.push({
        name: item.name,
        price: item.price,
        quantity: item.quantity,
        total: item.total,
        date: new Date().toISOString().split('T')[0],
        timestamp: new Date().toISOString()
      });

      localStorage.setItem('meatPurchases', JSON.stringify(purchases));
      renderReport();
      document.getElementById('analysisResults').innerHTML = '<p>–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—Ç—á—ë—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å –µ—â—ë —è—á–µ–π–∫—É¬ª, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</p>';
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function clearResults() {
      document.getElementById('analysisResults').innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å —è—á–µ–π–∫—É¬ª.</p>';
      if (highlightDiv) highlightDiv.remove();
      isSelecting = false;
    }

    // –†–µ–¥–∞–∫—Ç–æ—Ä —Ü–µ–Ω
    function renderPriceEditor() {
      const container = document.getElementById('priceEditorContainer');
      let html = '';
      meatItems.forEach(item => {
        html += `
          <div class="price-row">
            <span class="price-label">${item.name}:</span>
            <input type="number" class="price-input" data-id="${item.id}" value="${item.price}" step="1" min="0">
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω
    function savePrices() {
      const inputs = document.querySelectorAll('.price-input');
      inputs.forEach(input => {
        const id = parseInt(input.dataset.id);
        const price = parseFloat(input.value) || 0;
        const item = meatItems.find(i => i.id === id);
        if (item) item.price = price;
      });
      localStorage.setItem('meatItems', JSON.stringify(meatItems));
      renderPriceEditor();
      alert("–¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    }

    // –û—Ç—á—ë—Ç
    function renderReport() {
      const container = document.getElementById('reportsContainer');
      const today = new Date().toISOString().split('T')[0];

      let spent = 0;
      let itemsHtml = '';

      purchases.forEach(p => {
        spent += p.total;
        itemsHtml += `<div class="item buy-item">‚Äì ${p.name} √ó${p.quantity} –ø–æ ${p.price} = ${p.total} r (${p.date})</div>`;
      });

      container.innerHTML = `
        <div class="period-header">–í—Å–µ –ø–æ–∫—É–ø–∫–∏</div>
        <div>${itemsHtml}</div>
        <div class="summary">–û–±—â–∞—è —Å—É–º–º–∞: <strong>${spent.toFixed(0)} r</strong></div>
      `;
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    function clearAllData() {
      if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?")) {
        purchases = [];
        localStorage.removeItem('meatPurchases');
        renderReport();
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const savedItems = JSON.parse(localStorage.getItem('meatItems'));
    if (savedItems) meatItems = savedItems;

    renderPriceEditor();
    renderReport();
  </script>

</body>
</html>
